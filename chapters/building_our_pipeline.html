
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <title>Building Our Pipeline · HonKit</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 3.6.16">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="autodeploy_to_heroku.html" />
    
    
    <link rel="prev" href="pushing_to_gitlab.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="what_you_will_learn.html">
            
                <a href="what_you_will_learn.html">
            
                    
                    What you will learn
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="what_you_need_to_start.html">
            
                <a href="what_you_need_to_start.html">
            
                    
                    What you need to start
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="starting_the_project.html">
            
                <a href="starting_the_project.html">
            
                    
                    Starting the project
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="taking_care_of_the_environment.html">
            
                <a href="taking_care_of_the_environment.html">
            
                    
                    Taking care of the Environment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="connecting_the_database.html">
            
                <a href="connecting_the_database.html">
            
                    
                    Connecting the database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="pushing_to_gitlab.html">
            
                <a href="pushing_to_gitlab.html">
            
                    
                    Pushing To GitLab
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.8" data-path="building_our_pipeline.html">
            
                <a href="building_our_pipeline.html">
            
                    
                    Building Our Pipeline
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="autodeploy_to_heroku.html">
            
                <a href="autodeploy_to_heroku.html">
            
                    
                    Autodeploy to heroku
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Building Our Pipeline</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div class="sect1">
<h2 id="_building_our_pipeline">Building Our Pipeline</h2>
<div class="sectionbody">
<div class="paragraph">
<p>What we have so far is a basic Django project.
With everything we did so far, we have a decent basis to extend the project by adding a superuser, apps, models, views, templates, etc.</p>
</div>
<div class="paragraph">
<p>However, to quickly release new features in the future we continue to concentrate on our deployment pipeline.
When we push our code to our remote repository, we want GitLab to autodeploy our project to heroku.
In order to do this, we must enhance our Django project to a proper heroku app and add a <em>.gitlab-ci.yml</em> file.</p>
</div>
<div class="sect2">
<h3 id="_create_a_heroku_app">Create a heroku app</h3>
<div class="paragraph">
<p>Verify that you are logged in with the correct heroku user:</p>
</div>
<div class="listingblock">
<div class="title">Terminal</div>
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">heroku auth:whoami</code></pre>
</div>
</div>
<div class="paragraph">
<p>Chose a unqiue name and <a href="https://devcenter.heroku.com/articles/regions" target="_blank">region</a> for your heroku app.</p>
</div>
<div class="paragraph">
<p>Then create your heroku app with the <em>heroku CLI</em>:</p>
</div>
<div class="listingblock">
<div class="title">Terminal</div>
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell"><span class="hljs-meta">#</span><span class="bash"><span class="hljs-comment"># Important: Change {appname} to a unique app name and {region} to your preferred region.</span></span>
heroku apps:create {appname} --region {region}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_a_procfile_with_gunicorn">Create a Procfile with Gunicorn</h3>
<div class="paragraph">
<p>All Heroku applications require a <em>Procfile</em>.
This file file must be located in the root of the project.
It declares how Heroku should run your application.</p>
</div>
<div class="paragraph">
<p>For Django we will tell Heroku to run  a <em>Gunicorn</em> server for us.</p>
</div>
<div class="paragraph">
<p>Create a <em>Procfile</em>:</p>
</div>
<div class="listingblock">
<div class="title">Terminal</div>
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">echo web: gunicorn djangoku.wsgi &gt; Procfile</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you named your project differently, you need to adjust the command above accordingly.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Install <code>gunicorn</code>:</p>
</div>
<div class="listingblock">
<div class="title">Terminal</div>
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">pip install gunicorn</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_add_django_heroku">Add <code>django-heroku</code></h3>
<div class="paragraph">
<p>With <a href="https://github.com/heroku/django-heroku" target="_blank">django-heroku</a> Heroku provides a handy Python package that helps dealing with configuration settings for Heroku.
Especially the handling of settings, static files and logging is much easier with it.
All required dependencies are downloaded automatically for us.</p>
</div>
<div class="paragraph">
<p>Install <code>django-heroku</code>:</p>
</div>
<div class="listingblock">
<div class="title">Terminal</div>
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">pip install django-heroku</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add it to our <em>settings.py</em> file:</p>
</div>
<div class="listingblock">
<div class="title">djangoku/settings.py (At the bottom of the file)</div>
<div class="content">
<pre class="highlight"><code class="language-Python" data-lang="Python"><span class="hljs-keyword">import</span> django_heroku
django_heroku.settings(<span class="hljs-built_in">locals</span>())</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_update_our_requirements">Update our requirements</h3>
<div class="paragraph">
<p>With two new modules in our project, let’s update our requirements.</p>
</div>
<div class="paragraph">
<p>Update <em>requirements.txt</em>:</p>
</div>
<div class="listingblock">
<div class="title">Terminal</div>
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">pip freeze &gt; requirements.txt</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_adding_gitlab_ci_instructions">Adding GitLab CI instructions</h3>
<div class="paragraph">
<p>Now that our Heroku requirements are fulfilled, we need to tell GitLab to deploy our code to Heroku on push.
We do this by adding a CI/CD pipeline to our remote repository.
GitLab creates this pipeline automatically when a <code>gitlab-ci.yml</code> file is present in the root of the repository.</p>
</div>
<div class="paragraph">
<p>Our <code>gitlab-ci.yml</code> contain instructions about connecting with Heroku.
The authorization will be done by an env variable named <code>HEROKU_PRODUCTION_API_KEY</code>.</p>
</div>
<div class="sect3">
<h4 id="_get_your_heroku_api_key">Get your Heroku API key</h4>
<div class="paragraph">
<p>You can find your Heroku API key (aka. auth token) in your Heroku <a href="https://dashboard.heroku.com/account" target="_blank">account settings</a>.
You can also retrieve it with the commandline.</p>
</div>
<div class="paragraph">
<p>Copy the API key to your clipboard:</p>
</div>
<div class="listingblock">
<div class="title">Terminal</div>
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">heroku auth:token | pbcopy</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_add_the_heroku_api_key_to_gitlab">Add the Heroku API key to GitLab</h4>
<div class="paragraph">
<p>To add custom env variables to your GitLab repo, we must go to the settings of our repository on <a href="https://gitlab.com" target="_blank">gitlab.com</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Browser (any window)</div>
<ol class="arabic">
<li>
<p>Go to your project’s <strong>Settings &gt; CI/CD</strong> and expand the <strong>Variables</strong> section.</p>
</li>
<li>
<p>Click the <strong>Add Variable</strong> button.</p>
</li>
<li>
<p>Add a variable named <code>HEROKU_API_KEY</code> with your Heroku API key (see above) as value.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
You may need to delete the newline the auth token, when you used <code>pbcopy</code> to add it to your clipboard.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_create_the_gitlab_ci_yml_file">Create the <em>.gitlab-ci.yml</em> file</h4>
<div class="paragraph">
<p>Back in the terminal, create the <em>gitlab-ci.yml</em> file:</p>
</div>
<div class="listingblock">
<div class="title">Terminal</div>
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">touch gitlab-ci.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the Heroku deploy stage to the <em>gitlab-ci.yml</em> file:</p>
</div>
<div class="listingblock">
<div class="title">gitlab-ci.yml</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-string">//</span> <span class="hljs-attr">Important:</span> <span class="hljs-string">Change</span> {<span class="hljs-string">appname</span>} <span class="hljs-string">to</span> <span class="hljs-string">your</span> <span class="hljs-string">heroku</span> <span class="hljs-string">app</span> <span class="hljs-string">name</span>
<span class="hljs-attr">heroku:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">deploy</span>
  <span class="hljs-attr">script:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">apt-get</span> <span class="hljs-string">update</span> <span class="hljs-string">-qy</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">apt-get</span> <span class="hljs-string">install</span> <span class="hljs-string">-y</span> <span class="hljs-string">ruby-dev</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">gem</span> <span class="hljs-string">install</span> <span class="hljs-string">dpl</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">dpl</span> <span class="hljs-string">--provider=heroku</span> <span class="hljs-string">--app={appname}</span> <span class="hljs-string">--api-key=$HEROKU_API_KEY</span>
<span class="hljs-meta">---</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is a very basic example of a <em>gitlab-ci.yml</em> file.
Feel free to let it run tests or only deploy if you push to a specific branch.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See the <a href="https://docs.gitlab.com/ee/ci/README.html" target="_blank">GitLab CI/CD documentation</a> for more information.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_committing_the_code">Committing the code</h3>
<div class="paragraph">
<p>If you run <code>git status</code> you will see, that we updated <em>requirements.txt</em>, and added <em>Procfile</em> and <em>gitlab-ci.yml</em>.</p>
</div>
<div class="paragraph">
<p>Now we can stage and commit our changes:</p>
</div>
<div class="listingblock">
<div class="title">Terminal (same window)</div>
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">git add .
git commit -m &quot;Add deployment pipeline ☁️&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You see that we did not push our code yet.
We will give this important step the individual chapter it deserves.</p>
</div>
</div>
<div class="sect2">
<h3 id="_checklist">Checklist</h3>
<div class="sect3">
<h4 id="_heroku_app_exists">✔︎ Heroku app exists</h4>
<div class="listingblock">
<div class="title">Terminal</div>
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">heroku apps</code></pre>
</div>
</div>
<div class="paragraph">
<p>→ Your app is part of the heroku apps list</p>
</div>
</div>
<div class="sect3">
<h4 id="_procfile_is_present">✔︎ Procfile is present</h4>

</div>
<div class="sect3">
<h4 id="_gunicorn_is_part_of_requirements">✔︎ Gunicorn is part of requirements</h4>

</div>
<div class="sect3">
<h4 id="_django_heroku_is_part_of_our_requirements">✔︎ django-heroku is part of our requirements</h4>

</div>
<div class="sect3">
<h4 id="_gitlab_ci_yml_is_present">✔︎ gitlab-ci.yml is present</h4>

</div>
</div>
</div>
</div>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="pushing_to_gitlab.html" class="navigation navigation-prev " aria-label="Previous page: Pushing To GitLab">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="autodeploy_to_heroku.html" class="navigation navigation-next " aria-label="Next page: Autodeploy to heroku">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Building Our Pipeline","level":"1.8","depth":1,"next":{"title":"Autodeploy to heroku","level":"1.9","depth":1,"path":"chapters/autodeploy_to_heroku.adoc","ref":"chapters/autodeploy_to_heroku.adoc","articles":[]},"previous":{"title":"Pushing To GitLab","level":"1.7","depth":1,"path":"chapters/pushing_to_gitlab.adoc","ref":"chapters/pushing_to_gitlab.adoc","articles":[]},"dir":"ltr"},"config":{"plugins":[],"root":"book","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":16,"fontFamily":"IBMPlexSans","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":true},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"gitbook":"*"},"file":{"path":"chapters/building_our_pipeline.adoc","mtime":"2021-02-05T15:49:26.935Z","type":"asciidoc"},"gitbook":{"version":"3.6.16","time":"2021-02-05T15:49:50.451Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

